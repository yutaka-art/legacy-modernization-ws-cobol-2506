*> filepath: /home/shinyay/work/COBOL/legacy-modernization-ws-cobol/src/AGECLI.cob
IDENTIFICATION DIVISION.
PROGRAM-ID. AGECLI.
AUTHOR. GitHub Copilot.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
SPECIAL-NAMES.
    CONSOLE IS DISPLAY-DEVICE.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-BIRTH-DATE-FIELDS.
   05 WS-BIRTH-YEAR          PIC 9(4).
   05 WS-BIRTH-MONTH         PIC 9(2).
   05 WS-BIRTH-DAY           PIC 9(2).
01 WS-BIRTH-DATE-INPUT      PIC X(8).

01 WS-CURRENT-DATE-FIELDS.
   05 WS-CURRENT-YEAR        PIC 9(4).
   05 WS-CURRENT-MONTH       PIC 9(2).
   05 WS-CURRENT-DAY         PIC 9(2).
   05 FILLER                 PIC X(6). *> For time part of CURRENT-DATE

01 WS-AGE                     PIC 9(3).
01 WS-TEMP-AGE                PIC S9(3) VALUE 0. *> Signed for intermediate calc

01 WS-DISPLAY-MESSAGE         PIC X(50).

PROCEDURE DIVISION.
MAIN-LOGIC.
    PERFORM INITIALIZE-DATA
    PERFORM ACCEPT-BIRTH-DATE
    PERFORM VALIDATE-BIRTH-DATE
    PERFORM FETCH-CURRENT-DATE
    PERFORM COMPUTE-AGE
    PERFORM DISPLAY-AGE-RESULT
    STOP RUN.

INITIALIZE-DATA.
    MOVE SPACES TO WS-DISPLAY-MESSAGE WS-BIRTH-DATE-INPUT
    MOVE ZEROS  TO WS-AGE WS-BIRTH-YEAR WS-BIRTH-MONTH WS-BIRTH-DAY.

ACCEPT-BIRTH-DATE.
    DISPLAY "生年月日を入力してください (例: 19900123): " NO ADVANCING
    ACCEPT WS-BIRTH-DATE-INPUT.

VALIDATE-BIRTH-DATE.
           MOVE WS-BIRTH-DATE-INPUT(1:4) TO WS-BIRTH-YEAR.
           MOVE WS-BIRTH-DATE-INPUT(5:2) TO WS-BIRTH-MONTH.
           MOVE WS-BIRTH-DATE-INPUT(7:2) TO WS-BIRTH-DAY.

           IF NOT (WS-BIRTH-YEAR NUMERIC AND WS-BIRTH-MONTH NUMERIC AND WS-BIRTH-DAY NUMERIC)
               DISPLAY "エラー: 生年月日は数字で入力してください。"
               STOP RUN
           END-IF.
    IF WS-BIRTH-YEAR < 1900 OR WS-BIRTH-YEAR > FUNCTION CURRENT-DATE(1:4)
        DISPLAY "エラー: 年の入力が不正です (1900-" FUNCTION CURRENT-DATE(1:4) "の範囲)。"
        STOP RUN
    END-IF.
    IF WS-BIRTH-MONTH < 1 OR WS-BIRTH-MONTH > 12
        DISPLAY "エラー: 月の入力が不正です (1-12の範囲)。"
        STOP RUN
    END-IF.
    IF WS-BIRTH-DAY < 1 OR WS-BIRTH-DAY > 31 *> TODO: 月ごとの日数チェックを追加
        DISPLAY "エラー: 日の入力が不正です (1-31の範囲)。"
        STOP RUN
    END-IF.

FETCH-CURRENT-DATE.
    MOVE FUNCTION CURRENT-DATE TO WS-CURRENT-DATE-FIELDS.

COMPUTE-AGE.
    COMPUTE WS-TEMP-AGE = WS-CURRENT-YEAR - WS-BIRTH-YEAR.

    IF WS-CURRENT-MONTH < WS-BIRTH-MONTH
        SUBTRACT 1 FROM WS-TEMP-AGE
    ELSE
        IF WS-CURRENT-MONTH = WS-BIRTH-MONTH AND
           WS-CURRENT-DAY < WS-BIRTH-DAY
            SUBTRACT 1 FROM WS-TEMP-AGE
        END-IF
    END-IF.

    IF WS-TEMP-AGE < 0
        MOVE 0 TO WS-AGE
        DISPLAY "エラー: 生年月日が未来の日付です。"
    ELSE
        MOVE WS-TEMP-AGE TO WS-AGE
    END-IF.

DISPLAY-AGE-RESULT.
    IF WS-TEMP-AGE >= 0
        STRING "あなたの現在の年齢は " WS-AGE "歳です。"
            DELIMITED BY SIZE
            INTO WS-DISPLAY-MESSAGE
        END-STRING
        DISPLAY WS-DISPLAY-MESSAGE
    END-IF.

END PROGRAM AGECLI.
